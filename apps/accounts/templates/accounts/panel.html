{% extends 'base.html' %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
<!-- otp_form.html -->
{% block title %}
    پنل کاربری
{% endblock %}
{% block content %}
    <section class="py-5 mt-5">
        <div class="container px-4 px-lg-5 my-5 " dir="rtl">
            <div class="row text-center align-items-start d-flex justify-content-center ">

                <div class="col-3 border mx-2" style="height: 650px;">
                    <ul class="mt-5">
                        <li class="text-end mt-3"><a href="#" id="user-profile-link">اطلاعات من</a></li>
                        <li class="text-end mt-3"><a href="#" id="order-history-link">تاریخچه سفارشات</a></li>
                        <li class="text-end mt-3"><a href="#" id="order-status-link">وضعیت سفارشات</a></li>
                        <li class="text-end mt-3"><a href="#" id="addresses-link">لیست آدرس های من</a></li>

                    </ul>
                </div>
                <div class="col-6 border h-100 mx-2" id="container">

                </div>

            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}

    <script>


        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("user-profile-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadUserAndProfileInfo();
            });

            function loadUserAndProfileInfo() {
                var xhrUser = new XMLHttpRequest();
                xhrUser.onreadystatechange = function () {
                    if (xhrUser.readyState === XMLHttpRequest.DONE) {
                        if (xhrUser.status === 200) {
                            var userData = JSON.parse(xhrUser.responseText);
                            loadProfileInfo(userData);
                        } else {
                            console.error("User request failed: " + xhrUser.status);
                        }
                    }
                };
                xhrUser.open("GET", "/accounts/panel/user-detail/", true);
                xhrUser.send();
            }

            function loadProfileInfo(userData) {
                var xhrProfile = new XMLHttpRequest();
                xhrProfile.onreadystatechange = function () {
                    if (xhrProfile.readyState === XMLHttpRequest.DONE) {
                        if (xhrProfile.status === 200) {
                            var profileData = JSON.parse(xhrProfile.responseText);
                            displayUserInfo(userData, profileData);
                        } else {
                            console.error("Profile request failed: " + xhrProfile.status);
                        }
                    }
                };
                xhrProfile.open("GET", "/accounts/panel/profile-detail/", true);
                xhrProfile.send();
            }

            function displayUserInfo(userData, profileData) {
                var container = document.getElementById("container");
                container.innerHTML = ""; // Clear existing content

                // Profile image
                var profileImage = `<img class="rounded-circle border mb-2 mt-5" style="width: 100px; height: auto;" src="${profileData.image ? profileData.image : 'static/images/profile.jpg'}" alt="Profile Image">`;
                container.insertAdjacentHTML('beforeend', profileImage);

                // User info
                var userInfo = `
                
                <div class="row mb-1 px-0 mx-0">
                    <div class="col pe-0 mx-0">
                    <label for="first-name" class="form-label">نام</label>
                    <input type="text" id="first-name" class="form-control mb-2" value="${userData.first_name}">
                    </div>
                    <div class="col ps-0 mx-0">
                    <label for="last-name" class="form-label ">نام خانوادگی</label>  
                    <input type="text" id="last-name" class="form-control mb-2" value="${userData.last_name}">
                    </div>
                </div>
                <div class="row mb-1 px-0 mx-0">
                    <label for="email" class="form-label">ایمیل</label> 
                    <input type="email" id="email" class="form-control mb-2" value="${userData.email}">
                    <label for="phone-number" class="form-label">شماره تماس</label> 
                    <input type="text" id="phone-number" class="form-control mb-2" value="${userData.phone_number}">
                </div>
                
                `;
                container.insertAdjacentHTML('beforeend', userInfo);
                const genderMapping = {
                    'female': 'خانم',
                    'male': 'آقا',
                };
                // Profile info
                if (profileData) {
                    var profileInfo = `
                    <div class="row mb-1 px-0 mx-0">
                    <div class="col pe-0 mx-0">
                    <label for="date-of-birth" class="form-label text-end">تاریخ تولد</label>
                    <input type="text" id="date-of-birth" class="form-control mb-2" value="${profileData.date_of_birth}">
                    </div>
                    <div class="col ps-0 mx-0">
                    <label for="gender" class="form-label">جنسیت</label>  
                    <input type="text" id="gender" class="form-control mb-2" value="${genderMapping[profileData.gender]}">
                    </div>
                    </div>
                    <button id="update-info-btn" class="btn btn-primary" onclick="updateProfileInfo()">به‌روزرسانی</button>     
`;
                    container.insertAdjacentHTML('beforeend', profileInfo);
                }
            }
        });

        function updateProfileInfo(userId) {
            var firstName = document.getElementById("first-name").value;
            var lastName = document.getElementById("last-name").value;
            var email = document.getElementById("email").value;
            var phoneNumber = document.getElementById("phone-number").value;
            var dateOfBirth = document.getElementById("date-of-birth").value; // Assuming this is the correct ID for the date of birth input
            var gender = document.getElementById("gender").value; // Assuming this is the correct ID for the gender input

            var updatedData = {
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone_number: phoneNumber,
                date_of_birth: dateOfBirth,
                gender: gender
            };

            fetch(`/accounts/panel/profile-edit/${userId}/`, { // Embedding userId in the URL
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Assuming you're using Django and need CSRF protection
                },
                body: JSON.stringify(updatedData)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Profile updated successfully');
                        // Optionally, you can reload the page or display a success message
                    } else {
                        console.error('Failed to update profile');
                        // Optionally, you can display an error message to the user
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Function to get CSRF token from cookie (if needed)
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function toggleOrderItems(orderId) {
            var orderItemsContainer = document.getElementById("order-items-container-" + orderId);
            var buttonText = document.getElementById("toggle-button-" + orderId);

            if (orderItemsContainer.style.display === "none") {
                orderItemsContainer.style.display = "block";
                buttonText.textContent = "بستن جزئیات";
            } else {
                orderItemsContainer.style.display = "none";
                buttonText.textContent = "نمایش جزئیات";
            }
        }

        function showOrderItems(orderId) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Parse response and display order items
                        var orderItems = JSON.parse(xhr.responseText);
                        var orderItemsContainer = document.getElementById("order-items-container-" + orderId);
                        orderItemsContainer.innerHTML = ""; // Clear existing content
                        orderItems.item_data.forEach(function (item) {
                            var itemDiv = document.createElement("div");
                            itemDiv.innerHTML = `
                            <p class="mb-3">محصول : ${item.product_name}</p>
                            <img style="width: 100px; height: auto;" src="${item.product_image !== null ? item.product_image.sub_image : 'path/to/placeholder/image.jpg'}" alt="Product Image">
                            <p>تعداد : ${item.quantity}</p>
                            <p>قیمت : ${item.product_price}</p>
                            <p class="mb-5">تخفیف : ${item.discount !== null ? item.discount : '-'}</p>
                        `;
                            orderItemsContainer.appendChild(itemDiv);
                        });
                        toggleOrderItems(orderId); // Toggle visibility
                    } else {
                        console.error("Request failed: " + xhr.status);
                    }
                }
            };
            xhr.open("GET", "/accounts/panel/order-detail/" + orderId + "/", true);
            xhr.send();
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("order-history-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadOrderHistory();
            });

            function loadOrderHistory() {

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Parse response and create div elements for each order item
                            var orders = JSON.parse(xhr.responseText)['delivered_order_data'];
                            var orderHistoryContainer = document.getElementById("container");
                            orderHistoryContainer.innerHTML = ""; // Clear existing content
                            orders.forEach(function (order) {
                                var orderDiv = document.createElement("div");
                                orderDiv.classList.add("order-item"); // Add a class for styling
                                // Extracting date, hour, and minute from the created_at timestamp
                                var createdAt = new Date(order.created_at);
                                var date = createdAt.toLocaleDateString('en-US');
                                var time = createdAt.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                                const statusMapping = {
                                    'processing': 'در حال پردازش',
                                    'delivered': 'ارسال شده',
                                    'cancelled': 'لغو شده',
                                    'returned': 'بازگردانده شده'
                                };

                                orderDiv.innerHTML = `
                                <p class="mt-5">تاریخ سفارش : ${date} | ${time}</p>
                                <p>وضعیت : ${statusMapping[order.status]}</p>
                                <p>قیمت نهایی : ${order.total_price}</p>
                                <p>آدرس : ${order.address}</p>
                                <p class="mb-5"><button id="toggle-button-${order.id}" class="btn btn-outline-dark" onclick="showOrderItems(${order.id})">نمایش جزئیات</button></p>
                                <div id="order-items-container-${order.id}" style="display: none;"></div>
                                `;
                                orderHistoryContainer.appendChild(orderDiv);
                            });
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/order-history/", true);
                xhr.send();
            }
        });
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("order-status-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadOrderHistory();
            });

            function loadOrderHistory() {

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Parse response and create div elements for each order item
                            var orders = JSON.parse(xhr.responseText)['not_delivered_order_data'];
                            var orderHistoryContainer = document.getElementById("container");
                            orderHistoryContainer.innerHTML = ""; // Clear existing content
                            orders.forEach(function (order) {
                                var orderDiv = document.createElement("div");
                                orderDiv.classList.add("order-item"); // Add a class for styling
                                // Extracting date, hour, and minute from the created_at timestamp
                                var createdAt = new Date(order.created_at);
                                var date = createdAt.toLocaleDateString('en-US');
                                var time = createdAt.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                                const statusMapping = {
                                    'processing': 'در حال پردازش',
                                    'delivered': 'ارسال شده',
                                    'cancelled': 'لغو شده',
                                    'returned': 'بازگردانده شده'
                                };

                                orderDiv.innerHTML = `
                                <p class="mt-5">تاریخ سفارش : ${date} | ${time}</p>
                                <p>وضعیت : ${statusMapping[order.status]}</p>
                                <p>قیمت نهایی : ${order.total_price}</p>
                                <p>آدرس : ${order.address}</p>
                                <p class="mb-5"><button id="toggle-button-${order.id}" class="btn btn-outline-dark" onclick="showOrderItems(${order.id})">نمایش جزئیات</button></p>
                                <div id="order-items-container-${order.id}" style="display: none;"></div>
                                `;
                                orderHistoryContainer.appendChild(orderDiv);
                            });
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/order-history/", true);
                xhr.send();
            }
        });


    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            function loadAddresses() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            var addresses = JSON.parse(xhr.responseText).addresses;
                            var addressesContainer = document.getElementById("container");
                            addressesContainer.innerHTML = "";
                            addresses.forEach(function (address) {
                                var addressDiv = document.createElement("div");
                                addressDiv.innerHTML = `

                            <div class="row mb-1 px-0 mx-0 mt-5">
                                <div class="col pe-0 mx-0">
                                    <label for="province-${address.id}" class="form-label">استان</label>
                                    <input type="text" id="province-${address.id}" class="form-control mb-2" value="${address.province}">
                                </div>
                                <div class="col ps-0 mx-0">
                                    <label for="city-${address.id}" class="form-label ">شهر</label>  
                                    <input type="text" id="city-${address.id}" class="form-control mb-2" value="${address.city}">
                                </div>
                            </div>
                            <div class="row px-0 mx-0">
                                <label for="complete-address-${address.id}" class="form-label">آدرس کامل</label> 
                                <input type="text" id="complete-address-${address.id}" class="form-control mb-2" value="${address.complete_address}">
                            </div>
                            <div class="row px-0 mx-0">
                                <label for="postal-code-${address.id}" class="form-label">کد پستی</label> 
                                <input type="text" id="postal-code-${address.id}" class="form-control mb-2" value="${address.postal_code}">
                            </div>
                            <div class="row mt-2 mb-5 px-0 mx-0 d-flex justify-content-center align-items-center border-bottom pb-5">
                                <button class="col-2 ms-2 btn btn-outline-secondary edit-address-btn" data-address-id="${address.id}">ویرایش</button>
                                <button class="col-2 me-2 btn btn-outline-danger delete-address-btn" data-address-id="${address.id}">حذف</button>
                            </div>
                            
                            `;
                                addressesContainer.appendChild(addressDiv);
                            });

                            // Call attachEditDeleteEventListeners here, after addresses are loaded
                            attachEditDeleteEventListeners();
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/addresses/", true);
                xhr.send();
            }

            function attachEditDeleteEventListeners() {
                var editButtons = document.querySelectorAll(".edit-address-btn");
                editButtons.forEach(function (button) {
                    button.addEventListener("click", function (event) {
                        var addressId = event.target.getAttribute("data-address-id");
                        editAddress(addressId);
                    });
                });

                var deleteButtons = document.querySelectorAll(".delete-address-btn");
                deleteButtons.forEach(function (button) {
                    button.addEventListener("click", function (event) {
                        var addressId = event.target.getAttribute("data-address-id");
                        var confirmation = confirm("آیا مطمئن هستید که می‌خواهید این آدرس را حذف کنید؟");
                        if (confirmation) {
                            deleteAddress(addressId);
                        }
                    });
                });
            }

            function editAddress(addressId) {
                var provinceInput = document.getElementById(`province-${addressId}`).value;
                var cityInput = document.getElementById(`city-${addressId}`).value;
                var completeAddressInput = document.getElementById(`complete-address-${addressId}`).value;
                var postalCodeInput = document.getElementById(`postal-code-${addressId}`).value;

                var addressData = {
                    province: provinceInput,
                    city: cityInput,
                    complete_address: completeAddressInput,
                    postal_code: postalCodeInput
                };

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            alert("آدرس با موفقیت به روزرسانی شد.");
                            // Optionally, you can update the UI to reflect the changes made.
                        } else {
                            // Handle edit failure
                            alert("خطا در به روزرسانی آدرس.");
                            console.error(xhr.responseText);
                        }
                    }
                };

                // Open the PUT request
                xhr.open("PUT", `/accounts/panel/addresses/edit/${addressId}/`, true);

                // Set the Content-Type header
                xhr.setRequestHeader("Content-Type", "application/json");

                // Set the CSRF token in the request headers
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));

                // Send the request with the updated address data
                xhr.send(JSON.stringify(addressData));
            }


            function deleteAddress(addressId) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 204) {
                            // Address deleted successfully
                            var deletedAddressElement = document.getElementById("address-" + addressId);
                            if (deletedAddressElement) {
                                // Remove the deleted address element from the DOM
                                deletedAddressElement.remove();
                            }
                            alert("آدرس با موفقیت حذف شد.");

                            // After deletion, reload the address list to update the UI
                            loadAddresses();
                        } else {
                            // Handle deletion failure
                            alert("خطا در حذف آدرس.");
                            console.error(xhr.responseText);
                        }
                    }
                };

                // Open the DELETE request
                xhr.open("DELETE", "/accounts/panel/addresses/" + addressId + "/", true);

                // Set the CSRF token in the request headers
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));

                // Send the request
                xhr.send();
            }

// Function to get CSRF token from cookie
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Load addresses when the addresses link is clicked
            document.getElementById("addresses-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadAddresses();
            });


            function addAddress() {
                // Extract values from input fields
                var provinceInput = document.getElementById("province").value;
                var cityInput = document.getElementById("city").value;
                var completeAddressInput = document.getElementById("complete-address").value;
                var postalCodeInput = document.getElementById("postal-code").value;

                // Create address data object
                var addressData = {
                    province: provinceInput,
                    city: cityInput,
                    complete_address: completeAddressInput,
                    postal_code: postalCodeInput
                };

                // Send data to server using XMLHttpRequest
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 201) {
                            // Address added successfully
                            alert("Address added successfully.");
                            // Optionally, you can clear the input fields or update the UI.
                            loadAddresses(); // Reload addresses after adding a new one
                        } else {
                            // Handle add failure
                            alert("Error adding address.");
                            console.error(xhr.responseText);
                        }
                    }
                };

                xhr.open("POST", "/accounts/panel/addresses/add/", true); // Endpoint for adding address
                xhr.setRequestHeader("Content-Type", "application/json"); // Set content type header
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken')); // Set CSRF token header
                xhr.send(JSON.stringify(addressData)); // Send data to server
            }


        });

    </script>

{% endblock %}