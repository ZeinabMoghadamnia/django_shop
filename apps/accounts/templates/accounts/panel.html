{% extends 'base.html' %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
<!-- otp_form.html -->
{% block title %}
    پنل کاربری
{% endblock %}
{% block content %}
    <section class="py-5 mt-5">
        <div class="container px-4 px-lg-5 my-5 " dir="rtl">
            <div class="row text-center align-items-start d-flex justify-content-center ">

                <div class="col-3 border mx-2" style="height: 650px;">
                    <ul class="mt-5">
                        <li class="text-end mt-3"><a href="#" id="user-profile-link">اطلاعات من</a></li>
                        <li class="text-end mt-3"><a href="#" id="order-history-link">تاریخچه سفارشات</a></li>
                        <li class="text-end mt-3"><a href="#" id="order-status-link">وضعیت سفارشات</a></li>
                        <li class="text-end mt-3"><a href="#" id="addresses-link">لیست آدرس های ثبت شده</a></li>

                    </ul>
                </div>
                <div class="col-6 border h-100 mx-2" id="container">

                </div>

            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}

    <script>
        function toggleOrderItems(orderId) {
            var orderItemsContainer = document.getElementById("order-items-container-" + orderId);
            var buttonText = document.getElementById("toggle-button-" + orderId);

            if (orderItemsContainer.style.display === "none") {
                orderItemsContainer.style.display = "block";
                buttonText.textContent = "بستن جزئیات";
            } else {
                orderItemsContainer.style.display = "none";
                buttonText.textContent = "نمایش جزئیات";
            }
        }

        function showOrderItems(orderId) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Parse response and display order items
                        var orderItems = JSON.parse(xhr.responseText);
                        var orderItemsContainer = document.getElementById("order-items-container-" + orderId);
                        orderItemsContainer.innerHTML = ""; // Clear existing content
                        orderItems.item_data.forEach(function (item) {
                            var itemDiv = document.createElement("div");
                            itemDiv.innerHTML = `
                            <p class="mb-3">محصول : ${item.product_name}</p>
                            <img style="width: 100px; height: auto;" src="${item.product_image !== null ? item.product_image.sub_image : 'path/to/placeholder/image.jpg'}" alt="Product Image">
                            <p>تعداد : ${item.quantity}</p>
                            <p>قیمت : ${item.product_price}</p>
                            <p class="mb-5">تخفیف : ${item.discount !== null ? item.discount : '-'}</p>
                        `;
                            orderItemsContainer.appendChild(itemDiv);
                        });
                        toggleOrderItems(orderId); // Toggle visibility
                    } else {
                        console.error("Request failed: " + xhr.status);
                    }
                }
            };
            xhr.open("GET", "/accounts/panel/order-detail/" + orderId + "/", true);
            xhr.send();
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("order-history-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadOrderHistory();
            });

            function loadOrderHistory() {

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Parse response and create div elements for each order item
                            var orders = JSON.parse(xhr.responseText)['delivered_order_data'];
                            var orderHistoryContainer = document.getElementById("container");
                            orderHistoryContainer.innerHTML = ""; // Clear existing content
                            orders.forEach(function (order) {
                                var orderDiv = document.createElement("div");
                                orderDiv.classList.add("order-item"); // Add a class for styling
                                // Extracting date, hour, and minute from the created_at timestamp
                                var createdAt = new Date(order.created_at);
                                var date = createdAt.toLocaleDateString('en-US');
                                var time = createdAt.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                                const statusMapping = {
                                    'processing': 'در حال پردازش',
                                    'delivered': 'ارسال شده',
                                    'cancelled': 'لغو شده',
                                    'returned': 'بازگردانده شده'
                                };

                                orderDiv.innerHTML = `
                                <p class="mt-5">تاریخ سفارش : ${date} | ${time}</p>
                                <p>وضعیت : ${statusMapping[order.status]}</p>
                                <p>قیمت نهایی : ${order.total_price}</p>
                                <p>آدرس : ${order.address}</p>
                                <p class="mb-5"><button id="toggle-button-${order.id}" class="btn btn-outline-dark" onclick="showOrderItems(${order.id})">نمایش جزئیات</button></p>
                                <div id="order-items-container-${order.id}" style="display: none;"></div>
                                `;
                                orderHistoryContainer.appendChild(orderDiv);
                            });
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/order-history/", true);
                xhr.send();
            }
        });
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("order-status-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadOrderHistory();
            });

            function loadOrderHistory() {

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Parse response and create div elements for each order item
                            var orders = JSON.parse(xhr.responseText)['not_delivered_order_data'];
                            var orderHistoryContainer = document.getElementById("container");
                            orderHistoryContainer.innerHTML = ""; // Clear existing content
                            orders.forEach(function (order) {
                                var orderDiv = document.createElement("div");
                                orderDiv.classList.add("order-item"); // Add a class for styling
                                // Extracting date, hour, and minute from the created_at timestamp
                                var createdAt = new Date(order.created_at);
                                var date = createdAt.toLocaleDateString('en-US');
                                var time = createdAt.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                                const statusMapping = {
                                    'processing': 'در حال پردازش',
                                    'delivered': 'ارسال شده',
                                    'cancelled': 'لغو شده',
                                    'returned': 'بازگردانده شده'
                                };

                                orderDiv.innerHTML = `
                                <p class="mt-5">تاریخ سفارش : ${date} | ${time}</p>
                                <p>وضعیت : ${statusMapping[order.status]}</p>
                                <p>قیمت نهایی : ${order.total_price}</p>
                                <p>آدرس : ${order.address}</p>
                                <p class="mb-5"><button id="toggle-button-${order.id}" class="btn btn-outline-dark" onclick="showOrderItems(${order.id})">نمایش جزئیات</button></p>
                                <div id="order-items-container-${order.id}" style="display: none;"></div>
                                `;
                                orderHistoryContainer.appendChild(orderDiv);
                            });
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/order-history/", true);
                xhr.send();
            }
        });


        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("addresses-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadAddresses();
            });

            function loadAddresses() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            var addressesContainer = document.getElementById("container");
                            addressesContainer.innerHTML = ""; // Clear existing content
                            var addresses = JSON.parse(xhr.responseText).addresses;
                            addresses.forEach(function (address) {
                                var addressDiv = document.createElement("div");
                                addressDiv.innerHTML = `
                                <p class="mt-5">${address.city}, ${address.province}, ${address.complete_address}</p>
                                <hr>
                            `;
                                addressesContainer.appendChild(addressDiv);
                            });
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/addresses/", true);
                xhr.send();
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("addresses-link").addEventListener("click", function (event) {
                event.preventDefault();
                loadAddresses();
            });

            function loadAddresses() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            var addressesContainer = document.getElementById("container");
                            addressesContainer.innerHTML = ""; // Clear existing content
                            var addresses = JSON.parse(xhr.responseText).addresses;
                            addresses.forEach(function (address) {
                                var addressDiv = document.createElement("div");
                                addressDiv.innerHTML = `
                        <p class="mt-5">${address.city}, ${address.province}, ${address.complete_address}</p>
                        <hr>
                        <button class="btn btn-outline-primary edit-address-btn" data-address-id="${address.id}">Edit</button>
                        <button class="btn btn-outline-danger delete-address-btn" data-address-id="${address.id}">Delete</button>
                    `;
                                addressesContainer.appendChild(addressDiv);
                            });

                            // Attach event listeners to edit and delete buttons
                            attachEditDeleteEventListeners();
                        } else {
                            console.error("Request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("GET", "/accounts/panel/addresses/", true);
                xhr.send();
            }

            function attachEditDeleteEventListeners() {
                var editButtons = document.querySelectorAll(".edit-address-btn");
                editButtons.forEach(function (button) {
                    button.addEventListener("click", function () {
                        var addressId = button.dataset.addressId;
                        // Call a function to handle the edit process with the addressId
                        handleEditAddress(addressId);
                    });
                });

                // Similarly, you can attach event listeners for delete buttons here if needed.
            }

            function handleEditAddress(addressId) {
                // Send a PUT request to the server with the addressId for editing
                // Example:
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Handle successful response if needed
                        } else {
                            console.error("Edit request failed: " + xhr.status);
                        }
                    }
                };
                xhr.open("PUT", "/accounts/panel/address/" + addressId + "/", true);
                // Set appropriate headers and send any required data
                xhr.send();
            }


            // Function to handle address deletion
            function deleteAddress(addressId) {
                var confirmDelete = confirm("Are you sure you want to delete this address?");
                if (confirmDelete) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status === 204) {
                                // Address deleted successfully, remove it from the UI
                                var addressDiv = document.querySelector(`[data-address-id="${addressId}"]`).parentNode;
                                addressDiv.remove();
                            } else {
                                console.error("Delete request failed: " + xhr.status);
                            }
                        }
                    };
                    xhr.open("DELETE", "/accounts/panel/addresses/" + addressId + "/", true);
                    xhr.send();
                }
            }
        });
    </script>

    {#    <script>#}
    {#        function toggleOrderItems(orderId) {#}
    {#            var orderItemsContainer = document.getElementById("order-items-container-" + orderId);#}
    {#            var buttonText = document.getElementById("toggle-button-" + orderId);#}
    {##}
    {#            if (orderItemsContainer.style.display === "none") {#}
    {#                orderItemsContainer.style.display = "block";#}
    {#                buttonText.textContent = "بستن جزئیات";#}
    {#            } else {#}
    {#                orderItemsContainer.style.display = "none";#}
    {#                buttonText.textContent = "نمایش جزئیات";#}
    {#            }#}
    {#        }#}
    {##}
    {#        function showOrderItems(orderId) {#}
    {#            var xhr = new XMLHttpRequest();#}
    {#            xhr.onreadystatechange = function () {#}
    {#                if (xhr.readyState === XMLHttpRequest.DONE) {#}
    {#                    if (xhr.status === 200) {#}
    {#                        // Parse response and display order items#}
    {#                        var orderItems = JSON.parse(xhr.responseText);#}
    {#                        var orderItemsContainer = document.getElementById("order-items-container-" + orderId);#}
    {#                        orderItemsContainer.innerHTML = ""; // Clear existing content#}
    {#                        orderItems.item_data.forEach(function (item) {#}
    {#                            var itemDiv = document.createElement("div");#}
    {#                            itemDiv.innerHTML = `#}
    {#                            <p class="mb-3">محصول : ${item.product_name}</p>#}
    {#                            <img style="width: 100px; height: auto;" src="${item.product_image !== null ? item.product_image.sub_image : 'path/to/placeholder/image.jpg'}" alt="Product Image">#}
    {#                            <p>تعداد : ${item.quantity}</p>#}
    {#                            <p>قیمت : ${item.product_price}</p>#}
    {#                            <p class="mb-5">تخفیف : ${item.discount !== null ? item.discount : '-'}</p>#}
    {#                        `;#}
    {#                            orderItemsContainer.appendChild(itemDiv);#}
    {#                        });#}
    {#                        toggleOrderItems(orderId); // Toggle visibility#}
    {#                    } else {#}
    {#                        console.error("Request failed: " + xhr.status);#}
    {#                    }#}
    {#                }#}
    {#            };#}
    {#            xhr.open("GET", "/accounts/panel/order-detail/" + orderId + "/", true);#}
    {#            xhr.send();#}
    {#        }#}
    {##}
    {#        document.addEventListener("DOMContentLoaded", function () {#}
    {#            document.getElementById("order-history-link").addEventListener("click", function (event) {#}
    {#                event.preventDefault();#}
    {#                loadOrderHistory();#}
    {#            });#}
    {##}
    {#            function loadOrderHistory() {#}
    {##}
    {#                var xhr = new XMLHttpRequest();#}
    {#                xhr.onreadystatechange = function () {#}
    {#                    if (xhr.readyState === XMLHttpRequest.DONE) {#}
    {#                        if (xhr.status === 200) {#}
    {#                            // Parse response and create div elements for each order item#}
    {#                            var orders = JSON.parse(xhr.responseText)['delivered_order_data'];#}
    {#                            var orderHistoryContainer = document.getElementById("container");#}
    {#                            orderHistoryContainer.innerHTML = ""; // Clear existing content#}
    {#                            orders.forEach(function (order) {#}
    {#                                var orderDiv = document.createElement("div");#}
    {#                                orderDiv.classList.add("order-item"); // Add a class for styling#}
    {#                                // Extracting date, hour, and minute from the created_at timestamp#}
    {#                                var createdAt = new Date(order.created_at);#}
    {#                                var date = createdAt.toLocaleDateString('en-US');#}
    {#                                var time = createdAt.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});#}
    {#                                const statusMapping = {#}
    {#                                    'processing': 'در حال پردازش',#}
    {#                                    'delivered': 'ارسال شده',#}
    {#                                    'cancelled': 'لغو شده',#}
    {#                                    'returned': 'بازگردانده شده'#}
    {#                                };#}
    {##}
    {#                                orderDiv.innerHTML = `#}
    {#                                <p class="mt-5">تاریخ سفارش : ${date} | ${time}</p>#}
    {#                                <p>وضعیت : ${statusMapping[order.status]}</p>#}
    {#                                <p>قیمت نهایی : ${order.total_price}</p>#}
    {#                                <p>آدرس : ${order.address}</p>#}
    {#                                <p class="mb-5"><button id="toggle-button-${order.id}" class="btn btn-outline-dark" onclick="showOrderItems(${order.id})">نمایش جزئیات</button></p>#}
    {#                                <div id="order-items-container-${order.id}" style="display: none;"></div>#}
    {#                                `;#}
    {#                                orderHistoryContainer.appendChild(orderDiv);#}
    {#                            });#}
    {#                        } else {#}
    {#                            console.error("Request failed: " + xhr.status);#}
    {#                        }#}
    {#                    }#}
    {#                };#}
    {#                xhr.open("GET", "/accounts/panel/order-history/", true);#}
    {#                xhr.send();#}
    {#            }#}
    {#        });#}
    {#        document.addEventListener("DOMContentLoaded", function () {#}
    {#            document.getElementById("order-status-link").addEventListener("click", function (event) {#}
    {#                event.preventDefault();#}
    {#                loadOrderHistory();#}
    {#            });#}
    {##}
    {#            function loadOrderHistory() {#}
    {##}
    {#                var xhr = new XMLHttpRequest();#}
    {#                xhr.onreadystatechange = function () {#}
    {#                    if (xhr.readyState === XMLHttpRequest.DONE) {#}
    {#                        if (xhr.status === 200) {#}
    {#                            // Parse response and create div elements for each order item#}
    {#                            var orders = JSON.parse(xhr.responseText)['not_delivered_order_data'];#}
    {#                            var orderHistoryContainer = document.getElementById("container");#}
    {#                            orderHistoryContainer.innerHTML = ""; // Clear existing content#}
    {#                            orders.forEach(function (order) {#}
    {#                                var orderDiv = document.createElement("div");#}
    {#                                orderDiv.classList.add("order-item"); // Add a class for styling#}
    {#                                // Extracting date, hour, and minute from the created_at timestamp#}
    {#                                var createdAt = new Date(order.created_at);#}
    {#                                var date = createdAt.toLocaleDateString('en-US');#}
    {#                                var time = createdAt.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});#}
    {#                                const statusMapping = {#}
    {#                                    'processing': 'در حال پردازش',#}
    {#                                    'delivered': 'ارسال شده',#}
    {#                                    'cancelled': 'لغو شده',#}
    {#                                    'returned': 'بازگردانده شده'#}
    {#                                };#}
    {##}
    {#                                orderDiv.innerHTML = `#}
    {#                                <p class="mt-5">تاریخ سفارش : ${date} | ${time}</p>#}
    {#                                <p>وضعیت : ${statusMapping[order.status]}</p>#}
    {#                                <p>قیمت نهایی : ${order.total_price}</p>#}
    {#                                <p>آدرس : ${order.address}</p>#}
    {#                                <p class="mb-5"><button id="toggle-button-${order.id}" class="btn btn-outline-dark" onclick="showOrderItems(${order.id})">نمایش جزئیات</button></p>#}
    {#                                <div id="order-items-container-${order.id}" style="display: none;"></div>#}
    {#                                `;#}
    {#                                orderHistoryContainer.appendChild(orderDiv);#}
    {#                            });#}
    {#                        } else {#}
    {#                            console.error("Request failed: " + xhr.status);#}
    {#                        }#}
    {#                    }#}
    {#                };#}
    {#                xhr.open("GET", "/accounts/panel/order-history/", true);#}
    {#                xhr.send();#}
    {#            }#}
    {#        });#}
    {##}
    {##}
    {#        document.addEventListener("DOMContentLoaded", function () {#}
    {#            document.getElementById("addresses-link").addEventListener("click", function (event) {#}
    {#                event.preventDefault();#}
    {#                loadAddresses();#}
    {#            });#}
    {##}
    {#            function loadAddresses() {#}
    {#                var xhr = new XMLHttpRequest();#}
    {#                xhr.onreadystatechange = function () {#}
    {#                    if (xhr.readyState === XMLHttpRequest.DONE) {#}
    {#                        if (xhr.status === 200) {#}
    {#                            var addressesContainer = document.getElementById("container");#}
    {#                            addressesContainer.innerHTML = ""; // Clear existing content#}
    {#                            var addresses = JSON.parse(xhr.responseText).addresses;#}
    {#                            addresses.forEach(function (address) {#}
    {#                                var addressDiv = document.createElement("div");#}
    {#                                addressDiv.innerHTML = `#}
    {#                                <p class="mt-5">${address.city}, ${address.province}, ${address.complete_address}</p>#}
    {#                                <hr>#}
    {#                            `;#}
    {#                                addressesContainer.appendChild(addressDiv);#}
    {#                            });#}
    {#                        } else {#}
    {#                            console.error("Request failed: " + xhr.status);#}
    {#                        }#}
    {#                    }#}
    {#                };#}
    {#                xhr.open("GET", "/accounts/panel/addresses/", true);#}
    {#                xhr.send();#}
    {#            }#}
    {#        });#}
    {##}
    {##}
    {#    </script>#}


{% endblock %}